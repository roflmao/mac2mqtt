name: Build and Release

on:
  push:
    branches:
      - master

permissions:
  contents: write

jobs:
  build-and-release:
    if: "!contains(github.event.head_commit.message, '[skip ci]')"
    runs-on: macos-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'

      - name: Generate version tag
        id: version
        run: |
          # Get the latest tag matching v*.*.* pattern
          LATEST_TAG=$(git tag -l "v*.*.*" | sort -V | tail -n1)

          if [ -z "$LATEST_TAG" ]; then
            # No existing tags, start with v1.0.0
            VERSION="v1.0.0"
          else
            # Parse the version and increment patch number
            echo "Latest tag: $LATEST_TAG"

            # Remove 'v' prefix and split into major.minor.patch
            VERSION_NUM="${LATEST_TAG#v}"
            MAJOR=$(echo $VERSION_NUM | cut -d. -f1)
            MINOR=$(echo $VERSION_NUM | cut -d. -f2)
            PATCH=$(echo $VERSION_NUM | cut -d. -f3)

            # Increment patch version
            PATCH=$((PATCH + 1))
            VERSION="v${MAJOR}.${MINOR}.${PATCH}"
          fi

          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "previous_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          echo "Generated version: $VERSION"

      - name: Update CHANGELOG.md
        run: |
          set -euo pipefail
          VERSION=${{ steps.version.outputs.version }}
          PREVIOUS_TAG=${{ steps.version.outputs.previous_tag }}
          RELEASE_DATE=$(date +%Y-%m-%d)

          if [ -z "$PREVIOUS_TAG" ]; then
            git log --no-merges --pretty=format:"%s" > /tmp/commits.txt
          else
            git log "${PREVIOUS_TAG}..HEAD" --no-merges --pretty=format:"%s" > /tmp/commits.txt
          fi

          if [ ! -s /tmp/commits.txt ]; then
            echo "Automated release" > /tmp/commits.txt
          fi

          export VERSION
          export RELEASE_DATE
          python <<'PY'
import os

version = os.environ["VERSION"].lstrip('v')
release_date = os.environ["RELEASE_DATE"]

with open("/tmp/commits.txt", "r", encoding="utf-8") as commits_file:
    commits = [line.strip() for line in commits_file if line.strip()]

bullet_lines = ''.join(f'        * {line}\n' for line in commits)
entry = f'{version}   {release_date}\n        [Patch]\n{bullet_lines}\n'

with open("CHANGELOG.md", "r", encoding="utf-8") as changelog:
    lines = changelog.readlines()

try:
    insert_index = next(i for i, line in enumerate(lines) if line.strip() == "```") + 1
except StopIteration:
    raise SystemExit("Could not find code fence in CHANGELOG.md")

lines.insert(insert_index, entry)

with open("CHANGELOG.md", "w", encoding="utf-8") as changelog:
    changelog.writelines(lines)
PY

      - name: Commit CHANGELOG update
        run: |
          set -euo pipefail
          VERSION=${{ steps.version.outputs.version }}

          if git diff --quiet CHANGELOG.md; then
            echo "CHANGELOG.md already up to date."
            exit 0
          fi

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -am "[skip ci] Update CHANGELOG for ${VERSION}"
          git push origin HEAD:${{ github.ref }}

      - name: Build for macOS (ARM64)
        run: |
          VERSION=${{ steps.version.outputs.version }}
          GOOS=darwin GOARCH=arm64 go build -ldflags "-X main.version=${VERSION}" -o mac2mqtt-darwin-arm64 .
          chmod +x mac2mqtt-darwin-arm64

      - name: Build for macOS (AMD64)
        run: |
          VERSION=${{ steps.version.outputs.version }}
          GOOS=darwin GOARCH=amd64 go build -ldflags "-X main.version=${VERSION}" -o mac2mqtt-darwin-amd64 .
          chmod +x mac2mqtt-darwin-amd64

      - name: Build for Linux (AMD64)
        run: |
          VERSION=${{ steps.version.outputs.version }}
          GOOS=linux GOARCH=amd64 go build -ldflags "-X main.version=${VERSION}" -o mac2mqtt-linux-amd64 .
          chmod +x mac2mqtt-linux-amd64

      - name: Build for Linux (ARM64)
        run: |
          VERSION=${{ steps.version.outputs.version }}
          GOOS=linux GOARCH=arm64 go build -ldflags "-X main.version=${VERSION}" -o mac2mqtt-linux-arm64 .
          chmod +x mac2mqtt-linux-arm64

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.version }}
          name: Release ${{ steps.version.outputs.version }}
          body: |
            Automated release for commit ${{ github.sha }}

            ## Changes
            ${{ github.event.head_commit.message }}

            ## Downloads
            - **macOS (Apple Silicon)**: mac2mqtt-darwin-arm64
            - **macOS (Intel)**: mac2mqtt-darwin-amd64
            - **Linux (AMD64)**: mac2mqtt-linux-amd64
            - **Linux (ARM64)**: mac2mqtt-linux-arm64

            ## Installation
            1. Download the appropriate binary for your system
            2. Rename it to `mac2mqtt` and make it executable: `chmod +x mac2mqtt`
            3. Move it to a location in your PATH, e.g., `/usr/local/bin/`
            4. Create your `mac2mqtt.yaml` configuration file
            5. Run `./mac2mqtt`
          draft: false
          prerelease: false
          files: |
            mac2mqtt-darwin-arm64
            mac2mqtt-darwin-amd64
            mac2mqtt-linux-amd64
            mac2mqtt-linux-arm64
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
